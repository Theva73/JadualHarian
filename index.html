<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Schedule (XML Loader)</title>
<style>
  body            { font-family: Arial, Helvetica, sans-serif; margin: 20px; }
  h2              { margin-top: 0; }
  .controls       { margin-bottom: 1rem; display: flex; gap: .5rem; flex-wrap: wrap; }
  button          { padding: .5rem .9rem; font-size: .9rem; cursor: pointer; border: 1px solid #888; border-radius: 4px; background:#fafafa; }
  button:disabled { opacity:.5; cursor:not-allowed; }
  input[type=file]{ display:none; }
  table           { border-collapse: collapse; width: 100%; min-width: 640px; }
  th, td          { border: 1px solid #ccc; padding: 6px; text-align: center; vertical-align: top; }
  th              { background: #f0f0f0; }
  tr:nth-child(even){ background: #fafafa; }
  small           { display:block; color:#555; font-size:.8em; }
  hr              { border:0; border-top:1px dotted #ccc; margin:.3em 0; }
  .table-wrapper  { overflow-x:auto; }
  /* make long tables scroll vertically but keep headers visible on tall screens */
  .table-wrapper  table{ border-collapse: separate; border-spacing:0; }
</style>
</head>
<body>

<h2>Weekly Schedule</h2>

<!-- ====== Controls ====== -->
<div class="controls">
  <input type="file" id="xmlFileInput" accept=".xml">
  <button id="uploadBtn">Upload XML</button>
  <button id="clearBtn" disabled>Clear Schedule</button>
</div>

<!-- ====== Schedule goes here ====== -->
<div id="scheduleContainer" class="table-wrapper"></div>

<script>
/* -------------------------------------------------
   DOM helpers
------------------------------------------------- */
const xmlInput   = document.getElementById('xmlFileInput');
const uploadBtn  = document.getElementById('uploadBtn');
const clearBtn   = document.getElementById('clearBtn');
const container  = document.getElementById('scheduleContainer');

/* -------------------------------------------------
   Event wiring
------------------------------------------------- */
uploadBtn.addEventListener('click', () => xmlInput.click());
xmlInput.addEventListener('change', handleFile);
clearBtn.addEventListener('click', clearSchedule);

/* -------------------------------------------------
   Handle XML -> table rendering
------------------------------------------------- */
function handleFile() {
  const file = xmlInput.files?.[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const xmlText = e.target.result;
      const doc     = new DOMParser().parseFromString(xmlText, 'text/xml');
      const data    = extractScheduleData(doc);
      renderSchedule(data);
      clearBtn.disabled = false;
    } catch (err) {
      alert('Unable to parse timetable: ' + err.message);
    }
  };
  reader.readAsText(file);
}

/**
 * Extracts days, periods and cards from aSc Timetables XML.
 * Falls back to alternative attribute/element names where possible.
 */
function extractScheduleData(doc) {
  // --- Days ------------------------------------------------------------
  const days = [...doc.querySelectorAll('days > day')].map(d =>
    d.getAttribute('long')  ||
    d.getAttribute('name')  ||
    d.getAttribute('short') ||
    d.textContent.trim()
  );

  if (!days.length) throw new Error('No <day> tags found');

  // --- Periods ---------------------------------------------------------
  const periodsRaw = [...doc.querySelectorAll('periods > period')];
  if (!periodsRaw.length) throw new Error('No <period> tags found');

  const periods = periodsRaw.map(p => {
    const start = p.getAttribute('starttime') || p.getAttribute('start') ||
                  p.querySelector('starttime')?.textContent?.trim();
    const end   = p.getAttribute('endtime')   || p.getAttribute('end')   ||
                  p.querySelector('endtime')?.textContent?.trim();
    return { start, end };
  });

  // --- Map <cards> into a lookup[dayIndex][periodIndex] ---------------
  const table = Array.from({ length: periods.length }, () =>
                Array.from({ length: days.length   }, () => [] ));

  [...doc.querySelectorAll('cards > card')].forEach(card => {
    const d  = +card.querySelector('dayid, day')?.textContent;
    const p  = +card.querySelector('period')?.textContent;
    if (Number.isFinite(d) && Number.isFinite(p) &&
        table[p] && table[p][d] !== undefined) {

      const subj = card.querySelector('subject, subj')?.textContent?.trim() || '—';
      const tchr = card.querySelector('teacher')?.textContent?.trim()      ||
                   card.querySelector('teacher1')?.textContent?.trim()      ||
                   card.querySelector('staff')?.textContent?.trim()         || '';
      table[p][d].push({ subject: subj, teacher: tchr });
    }
  });

  return { days, periods, table };
}

/* -------------------------------------------------
   Render HTML table
------------------------------------------------- */
function renderSchedule({ days, periods, table }) {
  container.innerHTML = '';               // wipe old
  const tbl = document.createElement('table');

  // ----- Header
  const thead = tbl.createTHead();
  const headRow = thead.insertRow();
  headRow.insertCell().outerHTML = '<th>Time</th>';
  days.forEach(d => headRow.insertCell().outerHTML = `<th>${d}</th>`);

  // ----- Body
  const tbody = tbl.createTBody();
  periods.forEach((per, rowIdx) => {
    const tr = tbody.insertRow();
    tr.insertCell().innerHTML = `${per.start}&nbsp;–&nbsp;${per.end}`;

    days.forEach((_, colIdx) => {
      const cell = tr.insertCell();
      const slot = table[rowIdx][colIdx];

      if (slot.length) {
        cell.innerHTML = slot.map(s =>
          `${s.subject}<br><small>${s.teacher}</small>`
        ).join('<hr>');
      }
    });
  });

  container.appendChild(tbl);
}

/* -------------------------------------------------
   Clear button helper
------------------------------------------------- */
function clearSchedule() {
  container.innerHTML = '';
  clearBtn.disabled = true;
  xmlInput.value = '';
}
</script>

</body>
</html>